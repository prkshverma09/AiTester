# E2E Test Suite Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Install Playwright, make `/student-demo` an interactive multi-question quiz, and write 20 E2E tests covering all user flows across the three app pages.

**Architecture:** Playwright runs against a live `next dev` server (auto-started by Playwright's `webServer`). The student demo page becomes a `'use client'` component using `useState` to track the current question index, selected answers, and completion state. Question data lives in `src/data/questions.ts`.

**Tech Stack:** `@playwright/test` v1.x, Chromium browser, Next.js 16 dev server on port 3000, TypeScript.

---

## Pre-flight

Confirm you are on the `main` branch in `/Users/prakashverma/projects/AiTester` and the Vitest suite still passes:

```bash
cd /Users/prakashverma/projects/AiTester && npm test
```

Expected: `14 tests passed`.

---

### Task 1: Set up isolated worktree

**Files:**
- No files changed (git plumbing only)

**Step 1: Create and enter worktree**

Use the `superpowers:using-git-worktrees` skill to create a new worktree named `e2e-tests`. All subsequent tasks run inside that worktree.

---

### Task 2: Install Playwright

**Files:**
- Modify: `package.json` (scripts)
- Create: `playwright.config.ts`

**Step 1: Install the package and Chromium browser**

```bash
cd /Users/prakashverma/projects/AiTester/.claude/worktrees/e2e-tests
npm install -D @playwright/test
npx playwright install chromium
```

Expected output ends with: `✓ Chromium ... downloaded`.

**Step 2: Add the test:e2e script to package.json**

In `package.json`, add to the `"scripts"` block:

```json
"test:e2e": "playwright test"
```

Full scripts block after edit:
```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "eslint",
  "test": "vitest run",
  "test:watch": "vitest",
  "test:coverage": "vitest run --coverage",
  "test:e2e": "playwright test"
}
```

**Step 3: Create playwright.config.ts**

Create `/Users/prakashverma/projects/AiTester/.claude/worktrees/e2e-tests/playwright.config.ts`:

```ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

**Step 4: Verify Playwright can start**

```bash
npx playwright test --list
```

Expected: prints `No tests found` (no spec files yet — that is correct at this point).

**Step 5: Commit**

```bash
git add package.json playwright.config.ts package-lock.json
git commit -m "feat(e2e): install Playwright and add config"
```

---

### Task 3: Create question data

**Files:**
- Create: `src/data/questions.ts`

**Step 1: Create the file**

```ts
export interface Question {
  text: string
  options: [string, string, string, string]
  correctIndex: 0 | 1 | 2 | 3
  concept: string
}

export const QUESTIONS: Question[] = [
  // Addition (Q1-3)
  {
    text: 'What is 4 + 3?',
    options: ['5', '6', '7', '8'],
    correctIndex: 2,
    concept: 'Addition',
  },
  {
    text: 'What is 9 + 6?',
    options: ['14', '15', '16', '17'],
    correctIndex: 1,
    concept: 'Addition',
  },
  {
    text: 'What is 13 + 8?',
    options: ['19', '20', '21', '22'],
    correctIndex: 2,
    concept: 'Addition',
  },
  // Subtraction (Q4-6)
  {
    text: 'What is 10 − 4?',
    options: ['5', '6', '7', '8'],
    correctIndex: 1,
    concept: 'Subtraction',
  },
  {
    text: 'What is 15 − 7?',
    options: ['7', '8', '9', '10'],
    correctIndex: 1,
    concept: 'Subtraction',
  },
  {
    text: 'What is 23 − 9?',
    options: ['12', '13', '14', '15'],
    correctIndex: 2,
    concept: 'Subtraction',
  },
  // Multiplication (Q7-10)
  {
    text: 'What is 6 × 7?',
    options: ['36', '40', '42', '48'],
    correctIndex: 2,
    concept: 'Multiplication',
  },
  {
    text: 'What is 8 × 9?',
    options: ['63', '72', '78', '81'],
    correctIndex: 1,
    concept: 'Multiplication',
  },
  {
    text: 'What is 7 × 8?',
    options: ['48', '54', '56', '64'],
    correctIndex: 2,
    concept: 'Multiplication',
  },
  {
    text: 'What is 4 × 6?',
    options: ['20', '22', '24', '26'],
    correctIndex: 2,
    concept: 'Multiplication',
  },
]
```

**Step 2: Verify TypeScript compiles cleanly**

```bash
npx tsc --noEmit
```

Expected: no errors.

**Step 3: Commit**

```bash
git add src/data/questions.ts
git commit -m "feat(e2e): add 10-question test data across addition, subtraction, multiplication"
```

---

### Task 4: Write student-demo E2E tests (RED)

These tests will FAIL because the page is still static. That is the goal of this task.

**Files:**
- Create: `e2e/student-demo.spec.ts`

**Step 1: Create e2e/ directory and spec file**

Create `e2e/student-demo.spec.ts`:

```ts
import { test, expect } from '@playwright/test'

test.describe('Student quiz flow', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/student-demo')
  })

  test('shows Question 1 of 10 on load', async ({ page }) => {
    await expect(page.getByTestId('question-label')).toContainText('Question 1 of 10')
  })

  test('progress bar is visible', async ({ page }) => {
    await expect(page.getByTestId('progress-bar')).toBeVisible()
  })

  test('Next without selection does not advance', async ({ page }) => {
    await page.getByTestId('next-btn').click()
    await expect(page.getByTestId('question-label')).toContainText('Question 1 of 10')
  })

  test('selecting an answer highlights the button', async ({ page }) => {
    await page.getByTestId('option-0').click()
    await expect(page.getByTestId('option-0')).toHaveClass(/border-amber-500/)
  })

  test('Next after selection advances to question 2', async ({ page }) => {
    await page.getByTestId('option-0').click()
    await page.getByTestId('next-btn').click()
    await expect(page.getByTestId('question-label')).toContainText('Question 2 of 10')
  })

  test('Back restores question 1 with prior selection', async ({ page }) => {
    await page.getByTestId('option-1').click()
    await page.getByTestId('next-btn').click()
    await expect(page.getByTestId('question-label')).toContainText('Question 2 of 10')
    await page.getByRole('button', { name: /back/i }).click()
    await expect(page.getByTestId('question-label')).toContainText('Question 1 of 10')
    await expect(page.getByTestId('option-1')).toHaveClass(/border-amber-500/)
  })

  test('completing all 10 questions shows score screen', async ({ page }) => {
    for (let i = 0; i < 10; i++) {
      await page.getByTestId('option-0').click()
      await page.getByTestId('next-btn').click()
    }
    await expect(page.getByTestId('score-heading')).toContainText('/ 10 correct')
  })

  test('Try Again resets to question 1', async ({ page }) => {
    for (let i = 0; i < 10; i++) {
      await page.getByTestId('option-0').click()
      await page.getByTestId('next-btn').click()
    }
    await page.getByTestId('try-again').click()
    await expect(page.getByTestId('question-label')).toContainText('Question 1 of 10')
  })
})
```

**Step 2: Run and confirm RED**

```bash
npm run test:e2e -- e2e/student-demo.spec.ts
```

Expected: all 8 tests fail (elements not found because page is still the old static version).

---

### Task 5: Implement interactive student-demo page (GREEN)

**Files:**
- Modify: `src/app/student-demo/page.tsx`

**Step 1: Rewrite the page as an interactive client component**

Replace the entire contents of `src/app/student-demo/page.tsx` with:

```tsx
'use client'

import { useState } from 'react'
import { StudentLayout } from '@/components/layouts/StudentLayout'
import { Button } from '@/components/ui/button'
import { Card, CardContent } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Badge } from '@/components/ui/badge'
import { QUESTIONS } from '@/data/questions'

export default function StudentDemoPage() {
  const [currentIndex, setCurrentIndex] = useState(0)
  const [selectedAnswers, setSelectedAnswers] = useState<number[]>(
    Array(QUESTIONS.length).fill(-1)
  )
  const [completed, setCompleted] = useState(false)

  const question = QUESTIONS[currentIndex]
  const selected = selectedAnswers[currentIndex]
  const progress = ((currentIndex + 1) / QUESTIONS.length) * 100

  function handleSelect(optionIndex: number) {
    setSelectedAnswers(prev => {
      const next = [...prev]
      next[currentIndex] = optionIndex
      return next
    })
  }

  function handleNext() {
    if (selected === -1) return
    if (currentIndex === QUESTIONS.length - 1) {
      setCompleted(true)
    } else {
      setCurrentIndex(i => i + 1)
    }
  }

  function handleBack() {
    if (currentIndex > 0) setCurrentIndex(i => i - 1)
  }

  function handleReset() {
    setCurrentIndex(0)
    setSelectedAnswers(Array(QUESTIONS.length).fill(-1))
    setCompleted(false)
  }

  if (completed) {
    const correct = selectedAnswers.filter(
      (ans, i) => ans === QUESTIONS[i].correctIndex
    ).length
    const pct = Math.round((correct / QUESTIONS.length) * 100)
    return (
      <StudentLayout>
        <div className="space-y-8 text-center">
          <h1
            data-testid="score-heading"
            className="text-4xl font-bold text-slate-800"
          >
            You got {correct} / {QUESTIONS.length} correct!
          </h1>
          <p className="text-2xl text-slate-600">{pct}%</p>
          <Button
            data-testid="try-again"
            size="lg"
            className="bg-amber-500 hover:bg-amber-600 text-base px-8"
            onClick={handleReset}
          >
            Try Again
          </Button>
        </div>
      </StudentLayout>
    )
  }

  return (
    <StudentLayout>
      <div className="space-y-8">
        {/* Progress header */}
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm text-amber-700">
            <span data-testid="question-label">
              Question {currentIndex + 1} of {QUESTIONS.length}
            </span>
            <Badge variant="secondary">{question.concept}</Badge>
          </div>
          <Progress
            data-testid="progress-bar"
            value={progress}
            className="h-3 rounded-full"
          />
        </div>

        {/* Question card */}
        <Card className="shadow-md border-2 border-amber-100">
          <CardContent className="pt-8 pb-8 text-center">
            <p className="text-4xl font-bold text-slate-800 tracking-tight">
              {question.text}
            </p>
          </CardContent>
        </Card>

        {/* Answer options */}
        <div className="grid grid-cols-2 gap-4">
          {question.options.map((option, i) => (
            <button
              key={i}
              data-testid={`option-${i}`}
              onClick={() => handleSelect(i)}
              className={`
                rounded-2xl border-2 p-6 text-3xl font-bold text-slate-700
                active:scale-95 transition-all duration-100
                min-h-[80px] cursor-pointer
                ${
                  selected === i
                    ? 'border-amber-500 bg-amber-100'
                    : 'border-amber-200 bg-white hover:border-amber-400 hover:bg-amber-50'
                }
              `}
            >
              {option}
            </button>
          ))}
        </div>

        {/* Navigation */}
        <div className="flex items-center justify-between pt-2">
          <Button
            variant="outline"
            size="lg"
            className="text-base px-8"
            onClick={handleBack}
            disabled={currentIndex === 0}
          >
            ← Back
          </Button>
          <span className="text-sm text-slate-400">Take your time!</span>
          <Button
            data-testid="next-btn"
            size="lg"
            className="text-base px-8 bg-amber-500 hover:bg-amber-600"
            onClick={handleNext}
          >
            Next →
          </Button>
        </div>
      </div>
    </StudentLayout>
  )
}
```

**Step 2: Run student-demo tests and confirm GREEN**

```bash
npm run test:e2e -- e2e/student-demo.spec.ts
```

Expected: `8 passed`.

**Step 3: Verify existing Vitest tests still pass**

```bash
npm test
```

Expected: `14 passed`.

**Step 4: Commit**

```bash
git add src/app/student-demo/page.tsx
git commit -m "feat(e2e): make student-demo interactive quiz with 10 questions and score screen"
```

---

### Task 6: Write and verify home page E2E tests

**Files:**
- Create: `e2e/home.spec.ts`

**Step 1: Create the spec file**

```ts
import { test, expect } from '@playwright/test'

test.describe('Home page', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/')
  })

  test('shows MathDiagnose heading', async ({ page }) => {
    await expect(
      page.getByRole('heading', { name: 'MathDiagnose' })
    ).toBeVisible()
  })

  test('navigates to parent dashboard on link click', async ({ page }) => {
    await page.getByRole('link', { name: /parent dashboard/i }).click()
    await expect(page).toHaveURL('/parent-demo')
    await expect(
      page.getByRole('heading', { name: 'Dashboard' })
    ).toBeVisible()
  })

  test('navigates to student test view on link click', async ({ page }) => {
    await page.getByRole('link', { name: /student test view/i }).click()
    await expect(page).toHaveURL('/student-demo')
    await expect(page.getByTestId('question-label')).toContainText(
      'Question 1 of 10'
    )
  })
})
```

**Step 2: Run and confirm GREEN**

```bash
npm run test:e2e -- e2e/home.spec.ts
```

Expected: `3 passed`.

**Step 3: Commit**

```bash
git add e2e/home.spec.ts
git commit -m "feat(e2e): add home page E2E tests"
```

---

### Task 7: Write and verify parent dashboard E2E tests

**Files:**
- Create: `e2e/parent-demo.spec.ts`

**Step 1: Create the spec file**

```ts
import { test, expect } from '@playwright/test'

test.describe('Parent dashboard', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/parent-demo')
  })

  test('shows Dashboard heading and welcome text', async ({ page }) => {
    await expect(
      page.getByRole('heading', { name: 'Dashboard' })
    ).toBeVisible()
    await expect(page.getByText(/Sarah.*3 children/)).toBeVisible()
  })

  test('shows Alice card with age 8 and 85% score', async ({ page }) => {
    await expect(page.getByText('Alice')).toBeVisible()
    await expect(page.getByText('Age 8')).toBeVisible()
    await expect(page.getByText('85%').first()).toBeVisible()
  })

  test('shows Bob card with age 10 and 62% score', async ({ page }) => {
    await expect(page.getByText('Bob')).toBeVisible()
    await expect(page.getByText('Age 10')).toBeVisible()
    await expect(page.getByText('62%')).toBeVisible()
  })

  test('shows Charlie card with no sessions message', async ({ page }) => {
    await expect(page.getByText('Charlie')).toBeVisible()
    await expect(page.getByText('No sessions yet')).toBeVisible()
  })

  test('shows exactly 3 Start Test buttons', async ({ page }) => {
    await expect(
      page.getByRole('button', { name: 'Start Test' })
    ).toHaveCount(3)
  })

  test('recent sessions table has exactly 4 data rows', async ({ page }) => {
    await expect(page.locator('tbody tr')).toHaveCount(4)
  })

  test('score colours: 91% and 85% are green, 74% and 62% are amber', async ({ page }) => {
    await expect(page.getByText('91%')).toHaveClass(/text-green-600/)
    await expect(page.getByText('85%').first()).toHaveClass(/text-green-600/)
    await expect(page.getByText('74%')).toHaveClass(/text-amber-600/)
    await expect(page.getByText('62%')).toHaveClass(/text-amber-600/)
  })

  test('shows exactly 4 View Report buttons', async ({ page }) => {
    await expect(
      page.getByRole('button', { name: 'View Report' })
    ).toHaveCount(4)
  })

  test('shows Add Child button', async ({ page }) => {
    await expect(
      page.getByRole('button', { name: '+ Add Child' })
    ).toBeVisible()
  })
})
```

**Step 2: Run and confirm GREEN**

```bash
npm run test:e2e -- e2e/parent-demo.spec.ts
```

Expected: `9 passed`.

**Step 3: Commit**

```bash
git add e2e/parent-demo.spec.ts
git commit -m "feat(e2e): add parent dashboard E2E tests"
```

---

### Task 8: Full verification and finish

**Step 1: Run the complete Playwright suite**

```bash
npm run test:e2e
```

Expected: `20 passed` (3 home + 9 parent + 8 student).

**Step 2: Run the full Vitest unit suite**

```bash
npm test
```

Expected: `14 passed`.

**Step 3: Run Next.js build (no type errors, no missing exports)**

```bash
npm run build
```

Expected: clean build, 4 routes listed (/, /parent-demo, /student-demo, /_not-found).

**Step 4: Use superpowers:finishing-a-development-branch to complete**

Follow the finishing skill: present the 4 merge options to the user and execute the chosen one.
